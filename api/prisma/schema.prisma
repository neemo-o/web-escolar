generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS
// =============================================================================

enum Role {
  ADMIN_GLOBAL
  SECRETARY
  TEACHER
  STUDENT
  GUARDIAN
}

enum PeriodStatus {
  OPEN
  CLOSED
}

enum TemplateType {
  FREE
  BOLETIM
  COMPROVANTE_MATRICULA
  HISTORICO_ESCOLAR
  DECLARACAO_FREQUENCIA
  FICHA_ALUNO
}


enum EnrollmentStatus {
  ATIVA
  CONCLUIDA
  CANCELADA
  TRANSFERIDA
  SUSPENSA
  TRANCADA
}

enum AssessmentStatus {
  RASCUNHO
  PUBLICADA
  ENCERRADA
  ANULADA
}

enum ActivityStatus {
  RASCUNHO
  PUBLICADA
  ENCERRADA
  ACEITA_ATRASO
  ARQUIVADA
}

enum AcademicYearStatus {
  PLANEJAMENTO
  EM_ANDAMENTO
  ENCERRADO
  ARQUIVADO
}

enum Shift {
  MANHA
  TARDE
  NOTURNO
  INTEGRAL
}

enum Gender {
  MASCULINO
  FEMININO
  OUTRO
  NAO_INFORMADO
}

enum StudentStatus {
  ATIVO
  TRANSFERIDO
  TRANCADO
  CONCLUIDO
  CANCELADO
}

enum TeacherStatus {
  ATIVO
  AFASTADO
  DESLIGADO
}

enum GuardianRelationType {
  PAI
  MAE
  TUTOR_LEGAL
  OUTRO
}

enum DocumentType {
  RG
  CPF
  CERTIDAO_NASCIMENTO
  COMPROVANTE_RESIDENCIA
  HISTORICO_ESCOLAR
  LAUDO_MEDICO
  FOTO
  OUTRO
}


enum DocumentCategory {
  DECLARACAO
  COMUNICADO
  ADVERTENCIA
  SUSPENSAO
  BOLETIM
  CONTRATO
  COMPROVANTE
  OUTRO
}

enum IssuedDocumentStatus {
  RASCUNHO
  EMITIDO
  ENTREGUE
  CANCELADO
}

enum MovementType {
  MATRICULA
  TRANSFERENCIA_TURMA
  TRANSFERENCIA_SERIE
  TRANCAMENTO
  REATIVACAO
  CONCLUSAO
  CANCELAMENTO
  OUTRO
}

// =============================================================================
// TENANT
// =============================================================================

model School {
  id        String    @id @default(uuid()) @db.Uuid
  name      String    @db.VarChar(200)
  cnpj      String    @unique @db.VarChar(18)
  slug      String    @unique @db.VarChar(100)
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  config             SchoolConfig?
  academicYears      AcademicYear[]
  gradeLevels        GradeLevel[]
  subjects           Subject[]
  classrooms         Classroom[]
  students           Student[]
  assessments        Assessment[]
  activities         Activity[]
  attendanceSessions AttendanceSession[]
  announcements      Announcement[]
  schoolEvents       SchoolEvent[]
  studentGuardians   StudentGuardian[]
  users              User[]
  enrollments        Enrollment[]
  notifications      Notification[]
  timeBlocks         TimeBlock[]
  rooms              Room[]
  documentTemplates DocumentTemplate[]
  issuedDocuments    IssuedDocument[]

  @@map("schools")
}

model SchoolConfig {
  id       String @id @default(uuid()) @db.Uuid
  schoolId String @unique @db.Uuid

  timezone String @default("America/Sao_Paulo") @db.VarChar(60)
  locale   String @default("pt-BR") @db.VarChar(10)

  primaryColor   String? @db.VarChar(7)
  secondaryColor String? @db.VarChar(7)
  logoUrl        String?
  displayName    String? @db.VarChar(200)

  periodType     String   @default("bimestre") @db.VarChar(20)
  periodsPerYear Int      @default(4)
  passingGrade   Decimal  @default(60.0) @db.Decimal(5, 2)
  gradeScale     Decimal  @default(100.0) @db.Decimal(5, 2)
  recoveryGrade  Decimal? @db.Decimal(5, 2)
  decimalPlaces  Int      @default(1)

  minAttendancePct    Decimal @default(75.0) @db.Decimal(5, 2)
  countAbsenceType    String  @default("por_aula") @db.VarChar(20)
  justifyAbsenceLimit Int     @default(10)

  allowGradeEditAfterClose Boolean @default(false)
  allowLateEnrollment      Boolean @default(false)
  requireGuardianApproval  Boolean @default(false)
  notifyGradeLaunch        Boolean @default(true)
  notifyAbsence            Boolean @default(true)
  notifyFrequencyThreshold Decimal @default(80.0) @db.Decimal(5, 2)

  directorName  String? @db.VarChar(200)
  directorTitle String? @default("Diretor(a)") @db.VarChar(100)

  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id])

  @@map("school_configs")
}

// =============================================================================
// USUÁRIOS E CONTROLE DE ACESSO
// =============================================================================

model User {
  id              String    @id @default(uuid()) @db.Uuid
  schoolId        String?   @db.Uuid
  email           String    @db.VarChar(255)
  passwordHash    String    @db.VarChar(255)
  name            String    @db.VarChar(200)
  phone           String?   @db.VarChar(20)
  avatarUrl       String?
  emailVerifiedAt DateTime?
  role            Role
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  school                          School?              @relation(fields: [schoolId], references: [id])
  studentProfile                  Student?             @relation("StudentUser")
  teacherProfile                  TeacherProfile?      @relation("TeacherUser")
  guardianProfile                 GuardianProfile?     @relation("GuardianUser")
  classroomTeachings              ClassroomTeacher[]   @relation("TeacherInClassroom")
  gradeLaunches                   StudentGrade[]       @relation("GradeLaunchedBy")
  attendanceSessions              AttendanceSession[]  @relation("SessionCreatedBy")
  activitiesCreated               Activity[]           @relation("ActivityCreatedBy")
  assessmentsCreated              Assessment[]         @relation("AssessmentCreatedBy")
  submissionFeedbacks             ActivitySubmission[] @relation("FeedbackBy")
  guardianStudents                StudentGuardian[]    @relation("GuardianUser")
  gradeAudits                     GradeAudit[]         @relation("GradeAuditChangedBy")
  enrollmentHistories             EnrollmentHistory[]  @relation("MovementCreatedBy")
  financialResponsibleEnrollments Enrollment[]         @relation("EnrollmentFinancialResponsible")
  notifications                   Notification[]
  schedulesAsTeacher              Schedule[]           @relation("ScheduleTeacher")
  createdTemplates   DocumentTemplate[] @relation("TemplateCreatedBy")
  createdDocuments   IssuedDocument[]   @relation("DocumentCreatedBy")
  deliveredDocuments IssuedDocument[]   @relation("DocumentDeliveredBy")

  @@unique([schoolId, email])
  @@index([schoolId])
  @@map("users")
}

// =============================================================================
// PERFIS ESTENDIDOS
// =============================================================================

model TeacherProfile {
  id             String        @id @default(uuid()) @db.Uuid
  schoolId       String        @db.Uuid
  userId         String        @unique @db.Uuid
  internalCode   String?       @db.VarChar(30)
  cpf            String?       @db.VarChar(20)
  rg             String?       @db.VarChar(20)
  birthDate      DateTime?     @db.Date
  gender         Gender?
  nationality    String?       @db.VarChar(100)
  formation      String?       @db.VarChar(200)
  specialization String?       @db.VarChar(200)
  workloadHours  Int?
  admissionDate  DateTime?     @db.Date
  status         TeacherStatus @default(ATIVO)
  zipCode        String?       @db.VarChar(9)
  street         String?       @db.VarChar(200)
  addressNumber  String?       @db.VarChar(20)
  neighborhood   String?       @db.VarChar(100)
  city           String?       @db.VarChar(100)
  state          String?       @db.VarChar(2)
  canGrade       Boolean       @default(true)
  canAttendance  Boolean       @default(true)
  canEditContent Boolean       @default(true)
  canViewReports Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user User @relation("TeacherUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("teacher_profiles")
}

model GuardianProfile {
  id             String    @id @default(uuid()) @db.Uuid
  schoolId       String    @db.Uuid
  userId         String    @unique @db.Uuid
  cpf            String?   @db.VarChar(20)
  rg             String?   @db.VarChar(20)
  birthDate      DateTime? @db.Date
  maritalStatus  String?   @db.VarChar(50)
  profession     String?   @db.VarChar(100)
  phoneSecondary String?   @db.VarChar(20)
  zipCode        String?   @db.VarChar(9)
  street         String?   @db.VarChar(200)
  addressNumber  String?   @db.VarChar(20)
  neighborhood   String?   @db.VarChar(100)
  city           String?   @db.VarChar(100)
  state          String?   @db.VarChar(2)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user User @relation("GuardianUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("guardian_profiles")
}

// =============================================================================
// ESTRUTURA ACADÊMICA
// =============================================================================

model AcademicYear {
  id        String             @id @default(uuid()) @db.Uuid
  schoolId  String             @db.Uuid
  year      Int
  startDate DateTime           @db.Date
  endDate   DateTime           @db.Date
  active    Boolean            @default(false)
  status    AcademicYearStatus @default(PLANEJAMENTO)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  school      School       @relation(fields: [schoolId], references: [id])
  periods     Period[]
  classrooms  Classroom[]
  enrollments Enrollment[]

  @@unique([schoolId, year])
  @@index([schoolId, active])
  @@index([schoolId, status])
  @@map("academic_years")
}

model Period {
  id             String       @id @default(uuid()) @db.Uuid
  schoolId       String       @db.Uuid
  academicYearId String       @db.Uuid
  name           String       @db.VarChar(50)
  sequence       Int
  startDate      DateTime     @db.Date
  endDate        DateTime     @db.Date
  status         PeriodStatus @default(OPEN)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  academicYear AcademicYear  @relation(fields: [academicYearId], references: [id])
  assessments  Assessment[]
  periodGrades PeriodGrade[]

  @@unique([academicYearId, sequence])
  @@index([schoolId, academicYearId])
  @@map("periods")
}

model GradeLevel {
  id          String    @id @default(uuid()) @db.Uuid
  schoolId    String    @db.Uuid
  name        String    @db.VarChar(100)
  code        String    @db.VarChar(20)
  description String?   @db.VarChar(255)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  school     School      @relation(fields: [schoolId], references: [id])
  classrooms Classroom[]

  @@unique([schoolId, code])
  @@index([schoolId])
  @@map("grade_levels")
}

model Subject {
  id          String    @id @default(uuid()) @db.Uuid
  schoolId    String    @db.Uuid
  name        String    @db.VarChar(100)
  code        String    @db.VarChar(20)
  description String?   @db.VarChar(255)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  school            School             @relation(fields: [schoolId], references: [id])
  classroomSubjects ClassroomSubject[]
  classroomTeachers ClassroomTeacher[]
  assessments       Assessment[]
  schedules         Schedule[]

  @@unique([schoolId, code])
  @@index([schoolId])
  @@map("subjects")
}

model DocumentTemplate {
  id                String           @id @default(uuid()) @db.Uuid
  schoolId          String           @db.Uuid
  name              String           @db.VarChar(200)
  category          DocumentCategory @default(OUTRO)
  templateType      TemplateType     @default(FREE)
  description       String?
  headerHtml        String?
  footerHtml        String?
  bodyTemplate      String           @default("")
  showLogo          Boolean          @default(true)
  requiresSignature Boolean          @default(false)
  structuredConfig  Json?
  active            Boolean          @default(true)
  createdById       String?          @db.Uuid
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  deletedAt         DateTime?

  school          School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdBy       User?            @relation("TemplateCreatedBy", fields: [createdById], references: [id])
  issuedDocuments IssuedDocument[]

  @@index([schoolId])
  @@index([schoolId, category])
  @@index([schoolId, templateType])
  @@map("document_templates")
}

model IssuedDocument {
  id               String               @id @default(uuid()) @db.Uuid
  schoolId         String               @db.Uuid
  templateId       String?              @db.Uuid
  studentId        String?              @db.Uuid
  enrollmentId     String?              @db.Uuid
  title            String               @db.VarChar(300)
  bodySnapshot     String               @default("")
  headerSnapshot   String?
  footerSnapshot   String?
  category         DocumentCategory     @default(OUTRO)
  status           IssuedDocumentStatus @default(RASCUNHO)
  structuredPayload Json?
  fileUrl          String?
  deliveredAt      DateTime?
  deliveredById    String?              @db.Uuid
  notes            String?
  createdById      String?              @db.Uuid
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  deletedAt        DateTime?

  school      School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  template    DocumentTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  student     Student?          @relation(fields: [studentId], references: [id], onDelete: SetNull)
  enrollment  Enrollment?       @relation(fields: [enrollmentId], references: [id], onDelete: SetNull)
  createdBy   User?             @relation("DocumentCreatedBy", fields: [createdById], references: [id])
  deliveredBy User?             @relation("DocumentDeliveredBy", fields: [deliveredById], references: [id])

  @@index([schoolId])
  @@index([schoolId, studentId])
  @@index([schoolId, status])
  @@index([schoolId, category])
  @@map("issued_documents")
}

model Classroom {
  id             String    @id @default(uuid()) @db.Uuid
  schoolId       String    @db.Uuid
  academicYearId String    @db.Uuid
  gradeLevelId   String    @db.Uuid
  name           String    @db.VarChar(50)
  shift          Shift
  capacity       Int
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  school             School              @relation(fields: [schoolId], references: [id])
  academicYear       AcademicYear        @relation(fields: [academicYearId], references: [id])
  gradeLevel         GradeLevel          @relation(fields: [gradeLevelId], references: [id])
  classroomSubjects  ClassroomSubject[]
  classroomTeachers  ClassroomTeacher[]
  schedules          Schedule[]
  enrollments        Enrollment[]
  assessments        Assessment[]
  activities         Activity[]
  attendanceSessions AttendanceSession[]

  @@unique([schoolId, academicYearId, name])
  @@index([schoolId, academicYearId])
  @@index([schoolId, gradeLevelId])
  @@map("classrooms")
}

model ClassroomSubject {
  id            String    @id @default(uuid()) @db.Uuid
  schoolId      String    @db.Uuid
  classroomId   String    @db.Uuid
  subjectId     String    @db.Uuid
  workloadHours Int?
  isRequired    Boolean   @default(true)
  dateFrom      DateTime  @db.Date
  dateTo        DateTime? @db.Date
  removedReason String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  classroom Classroom @relation(fields: [classroomId], references: [id])
  subject   Subject   @relation(fields: [subjectId], references: [id])

  @@index([schoolId, classroomId])
  @@map("classroom_subjects")
}

model ClassroomTeacher {
  id           String    @id @default(uuid()) @db.Uuid
  schoolId     String    @db.Uuid
  classroomId  String    @db.Uuid
  subjectId    String    @db.Uuid
  teacherId    String    @db.Uuid
  dateFrom     DateTime  @db.Date
  dateTo       DateTime? @db.Date
  reasonChange String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  classroom Classroom @relation(fields: [classroomId], references: [id])
  subject   Subject   @relation(fields: [subjectId], references: [id])
  teacher   User      @relation("TeacherInClassroom", fields: [teacherId], references: [id])

  @@index([schoolId, classroomId])
  @@index([schoolId, teacherId])
  @@map("classroom_teachers")
}

// =============================================================================
// BLOCOS DE HORÁRIO E SALAS
// =============================================================================

model TimeBlock {
  id        String   @id @default(uuid()) @db.Uuid
  schoolId  String   @db.Uuid
  name      String   @db.VarChar(50)
  startTime DateTime @db.Time()
  endTime   DateTime @db.Time()
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school     School      @relation(fields: [schoolId], references: [id])
  schedules  Schedule[]

  @@unique([schoolId, name])
  @@index([schoolId, order])
  @@index([schoolId, active])
  @@map("time_blocks")
}

model Room {
  id        String    @id @default(uuid()) @db.Uuid
  schoolId  String    @db.Uuid
  name      String    @db.VarChar(100)
  capacity  Int?
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  school    School     @relation(fields: [schoolId], references: [id])
  schedules Schedule[]

  @@unique([schoolId, name])
  @@index([schoolId, active])
  @@map("rooms")
}

// =============================================================================
// HORÁRIOS/AULAS
// =============================================================================

model Schedule {
  id           String   @id @default(uuid()) @db.Uuid
  schoolId     String   @db.Uuid
  classroomId  String   @db.Uuid
  subjectId    String   @db.Uuid
  teacherId    String?  @db.Uuid
  roomId       String?  @db.Uuid
  timeBlockId  String  @db.Uuid
  dayOfWeek    Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  classroom  Classroom  @relation(fields: [classroomId], references: [id])
  subject    Subject    @relation(fields: [subjectId], references: [id])
  teacher    User?      @relation("ScheduleTeacher", fields: [teacherId], references: [id])
  room       Room?      @relation(fields: [roomId], references: [id])
  timeBlock  TimeBlock? @relation(fields: [timeBlockId], references: [id])

  // Índices para buscas eficientes
  @@index([schoolId, classroomId])
  @@index([schoolId, dayOfWeek])
  @@index([schoolId, timeBlockId])
  @@index([schoolId, teacherId])
  @@index([schoolId, roomId])
  @@unique([classroomId, dayOfWeek, timeBlockId]) // Não permite conflito de horário na mesma turma
  @@map("schedules")
}

// =============================================================================
// ALUNOS E MATRÍCULAS
// =============================================================================

model Student {
  id               String        @id @default(uuid()) @db.Uuid
  schoolId         String        @db.Uuid
  name             String        @db.VarChar(200)
  socialName       String?       @db.VarChar(200)
  cpf              String?       @db.VarChar(20)
  rg               String?       @db.VarChar(20)
  birthCertificate String?       @db.VarChar(50)
  birthDate        DateTime?     @db.Date
  gender           Gender?
  nationality      String?       @db.VarChar(100)
  naturalidade     String?       @db.VarChar(100)
  email            String?       @db.VarChar(255)
  phone            String?       @db.VarChar(20)
  zipCode          String?       @db.VarChar(9)
  street           String?       @db.VarChar(200)
  addressNumber    String?       @db.VarChar(20)
  neighborhood     String?       @db.VarChar(100)
  city             String?       @db.VarChar(100)
  state            String?       @db.VarChar(2)
  avatarUrl        String?
  status           StudentStatus @default(ATIVO)
  exitDate         DateTime?     @db.Date
  userId           String?       @unique @db.Uuid
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?

  school          School              @relation(fields: [schoolId], references: [id])
  user            User?               @relation("StudentUser", fields: [userId], references: [id])
  guardians       StudentGuardian[]
  enrollments     Enrollment[]
  health          StudentHealth?
  documents       StudentDocument[]
  movementHistory EnrollmentHistory[]
  issuedDocuments IssuedDocument[]

  @@unique([schoolId, cpf])
  @@index([schoolId])
  @@index([schoolId, name])
  @@map("students")
}

model StudentHealth {
  id                  String   @id @default(uuid()) @db.Uuid
  schoolId            String   @db.Uuid
  studentId           String   @unique @db.Uuid
  allergies           String?
  dietaryRestrictions String?
  specialNeeds        String?
  medication          String?
  bloodType           String?  @db.VarChar(5)
  healthNotes         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([schoolId, studentId])
  @@map("student_health")
}

model StudentDocument {
  id        String       @id @default(uuid()) @db.Uuid
  schoolId  String       @db.Uuid
  studentId String       @db.Uuid
  type      DocumentType
  name      String       @db.VarChar(200)
  fileUrl   String?
  delivered Boolean      @default(false)
  notes     String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([schoolId, studentId])
  @@map("student_documents")
}

model StudentGuardian {
  id                     String               @id @default(uuid()) @db.Uuid
  schoolId               String               @db.Uuid
  studentId              String               @db.Uuid
  guardianId             String               @db.Uuid
  relationType           GuardianRelationType @default(OUTRO)
  isFinancialResponsible Boolean              @default(false)
  canPickUp              Boolean              @default(true)
  notes                  String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  school   School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student  Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  guardian User    @relation("GuardianUser", fields: [guardianId], references: [id], onDelete: Cascade)

  @@unique([studentId, guardianId])
  @@index([schoolId, studentId])
  @@map("student_guardians")
}

model Enrollment {
  id                             String           @id @default(uuid()) @db.Uuid
  schoolId                       String           @db.Uuid
  studentId                      String           @db.Uuid
  classroomId                    String           @db.Uuid
  academicYearId                 String           @db.Uuid
  enrollmentNumber               String           @db.VarChar(20)
  status                         EnrollmentStatus @default(ATIVA)
  enrolledAt                     DateTime         @db.Date
  exitDate                       DateTime?        @db.Date
  financialResponsibleGuardianId String?          @db.Uuid
  createdAt                      DateTime         @default(now())
  updatedAt                      DateTime         @updatedAt
  deletedAt                      DateTime?

  school                       School               @relation(fields: [schoolId], references: [id])
  student                      Student              @relation(fields: [studentId], references: [id])
  classroom                    Classroom            @relation(fields: [classroomId], references: [id])
  academicYear                 AcademicYear         @relation(fields: [academicYearId], references: [id])
  financialResponsibleGuardian User?                @relation("EnrollmentFinancialResponsible", fields: [financialResponsibleGuardianId], references: [id])
  studentGrades                StudentGrade[]
  periodGrades                 PeriodGrade[]
  finalGrades                  FinalGrade[]
  attendanceRecords            AttendanceRecord[]
  activitySubmissions          ActivitySubmission[]
  history                      EnrollmentHistory[]
  documents                    EnrollmentDocument[]
  issuedDocuments               IssuedDocument[]

  @@unique([schoolId, enrollmentNumber])
  @@index([schoolId, academicYearId, status])
  @@index([schoolId, studentId])
  @@index([schoolId, classroomId])
  @@map("enrollments")
}

model EnrollmentDocument {
  id           String       @id @default(uuid()) @db.Uuid
  schoolId     String       @db.Uuid
  enrollmentId String       @db.Uuid
  type         DocumentType
  name         String       @db.VarChar(200)
  fileUrl      String?
  delivered    Boolean      @default(false)
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([schoolId, enrollmentId])
  @@map("enrollment_documents")
}

model Notification {
  id        String    @id @default(uuid()) @db.Uuid
  schoolId  String    @db.Uuid
  userId    String    @db.Uuid
  type      String    @db.VarChar(60)
  title     String    @db.VarChar(120)
  message   String    @db.VarChar(500)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([schoolId, userId, readAt])
  @@index([schoolId, createdAt])
  @@map("notifications")
}

model EnrollmentHistory {
  id           String       @id @default(uuid()) @db.Uuid
  schoolId     String       @db.Uuid
  studentId    String       @db.Uuid
  enrollmentId String?      @db.Uuid
  type         MovementType
  description  String?
  fromValue    String?      @db.VarChar(200)
  toValue      String?      @db.VarChar(200)
  createdById  String?      @db.Uuid
  createdAt    DateTime     @default(now())

  student    Student     @relation(fields: [studentId], references: [id])
  enrollment Enrollment? @relation(fields: [enrollmentId], references: [id])
  createdBy  User?       @relation("MovementCreatedBy", fields: [createdById], references: [id])

  @@index([schoolId, studentId])
  @@map("enrollment_history")
}

model EnrollmentCounter {
  id         String   @id @default(uuid()) @db.Uuid
  schoolId   String   @db.Uuid
  year       Int
  lastNumber Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([schoolId, year])
  @@index([schoolId])
  @@map("enrollment_counters")
}

// =============================================================================
// AVALIAÇÕES E NOTAS
// =============================================================================

model Assessment {
  id          String           @id @default(uuid()) @db.Uuid
  schoolId    String           @db.Uuid
  classroomId String           @db.Uuid
  subjectId   String           @db.Uuid
  periodId    String           @db.Uuid
  createdById String           @db.Uuid
  title       String           @db.VarChar(200)
  type        String           @db.VarChar(50)
  status      AssessmentStatus @default(RASCUNHO)
  maxScore    Decimal          @db.Decimal(5, 2)
  weight      Decimal          @default(1.0) @db.Decimal(4, 2)
  date        DateTime         @db.Date
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  deletedAt   DateTime?

  school        School         @relation(fields: [schoolId], references: [id])
  classroom     Classroom      @relation(fields: [classroomId], references: [id])
  subject       Subject        @relation(fields: [subjectId], references: [id])
  period        Period         @relation(fields: [periodId], references: [id])
  createdBy     User           @relation("AssessmentCreatedBy", fields: [createdById], references: [id])
  studentGrades StudentGrade[]

  @@index([schoolId, classroomId, periodId])
  @@index([schoolId, classroomId, status])
  @@map("assessments")
}

model StudentGrade {
  id           String    @id @default(uuid()) @db.Uuid
  schoolId     String    @db.Uuid
  assessmentId String    @db.Uuid
  enrollmentId String    @db.Uuid
  score        Decimal?  @db.Decimal(5, 2)
  launchedById String?   @db.Uuid
  launchedAt   DateTime?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  assessment Assessment   @relation(fields: [assessmentId], references: [id])
  enrollment Enrollment   @relation(fields: [enrollmentId], references: [id])
  launchedBy User?        @relation("GradeLaunchedBy", fields: [launchedById], references: [id])
  audits     GradeAudit[]

  @@unique([assessmentId, enrollmentId])
  @@index([schoolId, assessmentId])
  @@index([schoolId, enrollmentId])
  @@map("student_grades")
}

model GradeAudit {
  id          String   @id @default(uuid()) @db.Uuid
  schoolId    String   @db.Uuid
  gradeId     String   @db.Uuid
  changedById String   @db.Uuid
  oldScore    Decimal? @db.Decimal(5, 2)
  newScore    Decimal? @db.Decimal(5, 2)
  reason      String?
  changedAt   DateTime @default(now())

  grade     StudentGrade @relation(fields: [gradeId], references: [id])
  changedBy User         @relation("GradeAuditChangedBy", fields: [changedById], references: [id])

  @@index([schoolId, gradeId])
  @@map("grade_audits")
}

model PeriodGrade {
  id           String   @id @default(uuid()) @db.Uuid
  schoolId     String   @db.Uuid
  periodId     String   @db.Uuid
  enrollmentId String   @db.Uuid
  average      Decimal  @db.Decimal(5, 2)
  passed       Boolean
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  period     Period     @relation(fields: [periodId], references: [id])
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])

  @@unique([periodId, enrollmentId])
  @@index([schoolId, enrollmentId])
  @@map("period_grades")
}

model FinalGrade {
  id           String   @id @default(uuid()) @db.Uuid
  schoolId     String   @db.Uuid
  enrollmentId String   @db.Uuid
  average      Decimal  @db.Decimal(5, 2)
  passed       Boolean
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])

  @@unique([enrollmentId])
  @@index([schoolId, enrollmentId])
  @@map("final_grades")
}

// =============================================================================
// FREQUÊNCIA
// =============================================================================

model AttendanceSession {
  id          String   @id @default(uuid()) @db.Uuid
  schoolId    String   @db.Uuid
  classroomId String   @db.Uuid
  subjectId   String?  @db.Uuid
  createdById String   @db.Uuid
  date        DateTime @db.Date
  totalSlots  Int      @default(1)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  school    School             @relation(fields: [schoolId], references: [id])
  classroom Classroom          @relation(fields: [classroomId], references: [id])
  createdBy User               @relation("SessionCreatedBy", fields: [createdById], references: [id])
  records   AttendanceRecord[]

  @@index([schoolId, classroomId, date])
  @@map("attendance_sessions")
}

model AttendanceRecord {
  id           String   @id @default(uuid()) @db.Uuid
  schoolId     String   @db.Uuid
  sessionId    String   @db.Uuid
  enrollmentId String   @db.Uuid
  present      Boolean  @default(false)
  justified    Boolean  @default(false)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  session    AttendanceSession @relation(fields: [sessionId], references: [id])
  enrollment Enrollment        @relation(fields: [enrollmentId], references: [id])

  @@unique([sessionId, enrollmentId])
  @@index([schoolId, sessionId])
  @@index([schoolId, enrollmentId])
  @@map("attendance_records")
}

// =============================================================================
// ATIVIDADES
// =============================================================================

model Activity {
  id          String         @id @default(uuid()) @db.Uuid
  schoolId    String         @db.Uuid
  classroomId String         @db.Uuid
  createdById String         @db.Uuid
  title       String         @db.VarChar(200)
  description String?
  status      ActivityStatus @default(RASCUNHO)
  dueDate     DateTime?      @db.Date
  maxScore    Decimal?       @db.Decimal(5, 2)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  school      School               @relation(fields: [schoolId], references: [id])
  classroom   Classroom            @relation(fields: [classroomId], references: [id])
  createdBy   User                 @relation("ActivityCreatedBy", fields: [createdById], references: [id])
  submissions ActivitySubmission[]

  @@index([schoolId, classroomId])
  @@map("activities")
}

model ActivitySubmission {
  id           String    @id @default(uuid()) @db.Uuid
  schoolId     String    @db.Uuid
  activityId   String    @db.Uuid
  enrollmentId String    @db.Uuid
  submittedAt  DateTime?
  score        Decimal?  @db.Decimal(5, 2)
  feedbackById String?   @db.Uuid
  feedback     String?
  fileUrl      String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  activity   Activity   @relation(fields: [activityId], references: [id])
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])
  feedbackBy User?      @relation("FeedbackBy", fields: [feedbackById], references: [id])

  @@unique([activityId, enrollmentId])
  @@index([schoolId, activityId])
  @@map("activity_submissions")
}

// =============================================================================
// COMUNICAÇÃO
// =============================================================================

model Announcement {
  id         String   @id @default(uuid()) @db.Uuid
  schoolId   String   @db.Uuid
  title      String   @db.VarChar(200)
  body       String
  targetRole Role?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
  @@map("announcements")
}

model SchoolEvent {
  id          String    @id @default(uuid()) @db.Uuid
  schoolId    String    @db.Uuid
  title       String    @db.VarChar(200)
  description String?
  startDate   DateTime
  endDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  school School @relation(fields: [schoolId], references: [id])

  @@index([schoolId])
  @@map("school_events")
}
